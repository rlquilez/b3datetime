# B3 DateTime API

API REST em Python para consultar horÃ¡rios de operaÃ§Ã£o e dias de negociaÃ§Ã£o da B3 (Bolsa de Valores de SÃ£o Paulo).

## ğŸ“‹ DescriÃ§Ã£o

A B3 DateTime API oferece endpoints para:
- Consultar horÃ¡rios de abertura e fechamento da bolsa (via Redis com cache local de 1h)
- Validar se determinada data Ã© dia de negociaÃ§Ã£o
- Listar dias de negociaÃ§Ã£o ou nÃ£o negociaÃ§Ã£o em um perÃ­odo
- Verificar a saÃºde da aplicaÃ§Ã£o e suas dependÃªncias

Utiliza o calendÃ¡rio BVMF (B3/Bovespa) do mÃ³dulo `exchange_calendars` com suporte a dados a partir de 01/01/2006.

## ğŸ—ï¸ Arquitetura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cliente   â”‚ â”€â”€â”€â–¶ â”‚ Kong Gateway â”‚ â”€â”€â”€â–¶ â”‚  B3 API      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  (FastAPI)   â”‚
                            â”‚               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚                      â”‚
                            â–¼                      â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   API Key    â”‚      â”‚    Redis     â”‚
                     â”‚  Management  â”‚      â”‚ (Cache 1h)   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**CaracterÃ­sticas**:
- **FastAPI**: Framework moderno e rÃ¡pido com documentaÃ§Ã£o automÃ¡tica OpenAPI/Redoc
- **Redis com Cache Local**: Fallback automÃ¡tico por atÃ© 1 hora se Redis estiver offline
- **Exchange Calendars**: CalendÃ¡rio oficial BVMF para validaÃ§Ã£o de dias Ãºteis
- **Timezone**: America/Sao_Paulo para todas as operaÃ§Ãµes
- **Docker Multi-arch**: Suporte para linux/amd64 e linux/arm64
- **CI/CD**: Pipeline automÃ¡tico via GitHub Actions

## ğŸš€ Endpoints

### HorÃ¡rios de OperaÃ§Ã£o

#### `GET /v1/hours`
Retorna horÃ¡rios de abertura e fechamento.

**Resposta:**
```json
{
  "open": "10:00",
  "close": "18:00"
}
```

**Exemplo:**
```bash
curl -H "apikey: YOUR_API_KEY" https://api.example.com/v1/hours
```

#### `GET /v1/hours/open`
Retorna apenas o horÃ¡rio de abertura.

**Resposta:**
```json
{
  "time": "10:00"
}
```

#### `GET /v1/hours/close`
Retorna apenas o horÃ¡rio de fechamento.

**Resposta:**
```json
{
  "time": "18:00"
}
```

### Dias de NegociaÃ§Ã£o

#### `GET /v1/is-trading-day`
Verifica se hoje Ã© dia de negociaÃ§Ã£o na B3.

**Resposta:**
```json
{
  "date": "2024-01-15",
  "is_trading_day": true
}
```

**Exemplo:**
```bash
curl -H "apikey: YOUR_API_KEY" https://api.example.com/v1/is-trading-day
```

#### `GET /v1/trading-days`
Lista dias de negociaÃ§Ã£o (ou nÃ£o negociaÃ§Ã£o) em um perÃ­odo.

**ParÃ¢metros:**
- `start` (obrigatÃ³rio): Data inicial no formato YYYY-MM-DD (>= 2006-01-01)
- `end` (obrigatÃ³rio): Data final no formato YYYY-MM-DD
- `exclude` (opcional): `true` para listar dias SEM negociaÃ§Ã£o, `false` (padrÃ£o) para listar dias COM negociaÃ§Ã£o

**Resposta (exclude=false):**
```json
[
  "2024-01-02",
  "2024-01-03",
  "2024-01-04",
  "2024-01-05",
  "2024-01-08"
]
```

**Resposta (exclude=true):**
```json
[
  "2024-01-01",
  "2024-01-06",
  "2024-01-07"
]
```

**Exemplos:**
```bash
# Listar dias COM negociaÃ§Ã£o
curl -H "apikey: YOUR_API_KEY" \
  "https://api.example.com/v1/trading-days?start=2024-01-01&end=2024-01-31"

# Listar dias SEM negociaÃ§Ã£o (feriados e finais de semana)
curl -H "apikey: YOUR_API_KEY" \
  "https://api.example.com/v1/trading-days?start=2024-01-01&end=2024-01-31&exclude=true"
```

### Health Check

#### `GET /v1/health`
Verifica a saÃºde da API e suas dependÃªncias.

**Resposta (healthy):**
```json
{
  "status": "healthy",
  "timestamp": "2024-01-15T10:30:00-03:00",
  "redis_status": "connected",
  "cache": {
    "redis_connected": true,
    "open_cache_age_seconds": 120,
    "close_cache_age_seconds": 120,
    "cache_ttl_seconds": 3600
  }
}
```

**Resposta (degraded - Redis offline, usando cache):**
```json
{
  "status": "degraded",
  "timestamp": "2024-01-15T10:30:00-03:00",
  "redis_status": "disconnected",
  "cache": {
    "redis_connected": false,
    "open_cache_age_seconds": 1800,
    "close_cache_age_seconds": 1800,
    "cache_ttl_seconds": 3600
  }
}
```

### InformaÃ§Ãµes da API

#### `GET /`
Retorna informaÃ§Ãµes bÃ¡sicas sobre a API.

**Resposta:**
```json
{
  "name": "B3 DateTime API",
  "version": "1.0.0",
  "description": "API para consultar horÃ¡rios e dias de operaÃ§Ã£o da B3",
  "docs": {
    "swagger": "/docs",
    "redoc": "/redoc",
    "openapi": "/openapi.json"
  },
  "endpoints": {
    "hours": {
      "all": "/v1/hours",
      "open": "/v1/hours/open",
      "close": "/v1/hours/close"
    },
    "dates": {
      "is_trading_day": "/v1/is-trading-day",
      "trading_days": "/v1/trading-days?start=YYYY-MM-DD&end=YYYY-MM-DD&exclude=false"
    },
    "health": "/v1/health"
  },
  "authentication": {
    "type": "API Key",
    "header": "apikey",
    "managed_by": "Kong Gateway"
  }
}
```

## ğŸ” AutenticaÃ§Ã£o

Todas as requisiÃ§Ãµes devem incluir o header `apikey` com uma chave vÃ¡lida:

```bash
curl -H "apikey: YOUR_API_KEY" https://api.example.com/v1/hours
```

A autenticaÃ§Ã£o Ã© gerenciada externamente pelo **Kong Gateway**. A API nÃ£o valida as chaves diretamente.

## âš™ï¸ VariÃ¡veis de Ambiente

| VariÃ¡vel | DescriÃ§Ã£o | PadrÃ£o | ObrigatÃ³rio |
|----------|-----------|--------|-------------|
| `REDIS_URL_ENV` | URL de conexÃ£o do Redis | `redis://localhost:6379` | Sim |
| `REDIS_KEY_OPEN` | Chave Redis para horÃ¡rio de abertura | `b3:trading:hours:open` | Sim |
| `REDIS_KEY_CLOSE` | Chave Redis para horÃ¡rio de fechamento | `b3:trading:hours:close` | Sim |

**Exemplo de configuraÃ§Ã£o (.env):**
```env
REDIS_URL_ENV=redis://localhost:6379
REDIS_KEY_OPEN=b3:trading:hours:open
REDIS_KEY_CLOSE=b3:trading:hours:close
```

## ğŸ’¾ Cache e Fallback

A API implementa um sistema de cache inteligente:

1. **Tentativa primÃ¡ria**: Busca valores diretamente do Redis
2. **Cache local**: Se Redis falhar, usa cache em memÃ³ria (vÃ¡lido por 1 hora)
3. **Erro 503**: Se Redis indisponÃ­vel por mais de 1 hora, retorna erro

**BenefÃ­cios:**
- Alta disponibilidade durante instabilidades temporÃ¡rias do Redis
- ReduÃ§Ã£o de latÃªncia com cache local
- DegradaÃ§Ã£o controlada do serviÃ§o

## ğŸ³ Docker

### Build Local

```bash
docker build -t b3datetime:latest .
```

### Executar Container

```bash
docker run -d \
  -p 8000:8000 \
  -e REDIS_URL_ENV=redis://redis-host:6379 \
  -e REDIS_KEY_OPEN=b3:trading:hours:open \
  -e REDIS_KEY_CLOSE=b3:trading:hours:close \
  --name b3datetime \
  b3datetime:latest
```

### Docker Compose

```yaml
version: '3.8'

services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
  
  b3datetime:
    build: .
    ports:
      - "8000:8000"
    environment:
      - REDIS_URL_ENV=redis://redis:6379
      - REDIS_KEY_OPEN=b3:trading:hours:open
      - REDIS_KEY_CLOSE=b3:trading:hours:close
    depends_on:
      - redis
```

## ğŸ’» Desenvolvimento Local

### PrÃ©-requisitos

- Python 3.11+
- Redis (local ou remoto)

### InstalaÃ§Ã£o

1. Clone o repositÃ³rio:
```bash
git clone https://github.com/rlquilez/b3datetime.git
cd b3datetime
```

2. Crie um ambiente virtual:
```bash
python -m venv venv
source venv/bin/activate  # Linux/macOS
# ou
venv\Scripts\activate  # Windows
```

3. Instale as dependÃªncias:
```bash
pip install -r requirements.txt
```

4. Configure as variÃ¡veis de ambiente:
```bash
cp .env.example .env
# Edite .env com suas configuraÃ§Ãµes
```

5. Inicie o servidor:
```bash
uvicorn src.main:app --reload --host 0.0.0.0 --port 8000
```

6. Acesse a documentaÃ§Ã£o:
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc
- OpenAPI JSON: http://localhost:8000/openapi.json

## ğŸ“Š Preparando Redis

Para que a API funcione corretamente, configure as chaves no Redis:

```bash
# Conectar ao Redis
redis-cli

# Configurar horÃ¡rios
SET b3:trading:hours:open "10:00"
SET b3:trading:hours:close "18:00"

# Verificar
GET b3:trading:hours:open
GET b3:trading:hours:close
```

## ğŸ”§ Tecnologias

- **[FastAPI](https://fastapi.tiangolo.com/)** - Framework web moderno e rÃ¡pido
- **[Uvicorn](https://www.uvicorn.org/)** - Servidor ASGI de alta performance
- **[Redis](https://redis.io/)** - Armazenamento de horÃ¡rios
- **[exchange_calendars](https://github.com/gerrymanoim/exchange_calendars)** - CalendÃ¡rios de bolsas de valores
- **[Pydantic](https://pydantic-docs.helpmanual.io/)** - ValidaÃ§Ã£o de dados
- **[Docker](https://www.docker.com/)** - ContainerizaÃ§Ã£o
- **[GitHub Actions](https://github.com/features/actions)** - CI/CD

## ğŸ“ LimitaÃ§Ãµes e ConsideraÃ§Ãµes

- **Data mÃ­nima**: CalendÃ¡rio BVMF disponÃ­vel a partir de **01/01/2006**
- **Timezone**: Todas as operaÃ§Ãµes utilizam **America/Sao_Paulo**
- **Cache TTL**: Cache local expira apÃ³s **1 hora (3600 segundos)**
- **Sem limite de range**: Endpoint `/v1/trading-days` aceita qualquer range desde que start >= 2006-01-01
- **HorÃ¡rios estÃ¡ticos**: HorÃ¡rios obtidos do Redis sÃ£o considerados estÃ¡ticos (nÃ£o considera pregÃµes especiais)

## ğŸš€ CI/CD

A aplicaÃ§Ã£o possui pipeline automÃ¡tico via GitHub Actions:

- **Trigger**: Push nas branches `main` ou `proxima`
- **Build**: Imagem Docker multi-arquitetura (linux/amd64, linux/arm64)
- **Push**: Enviado para registry configurado nos secrets
- **Cache**: Utiliza GitHub Actions cache para otimizaÃ§Ã£o

**Secrets necessÃ¡rios:**
- `GIT_REGISTRY` - URL do registry (ex: ghcr.io)
- `GIT_OWNER` - Owner/organizaÃ§Ã£o
- `GIT_REGISTRY_USER` - UsuÃ¡rio do registry
- `GIT_REGISTRY_PASSWORD` - Token/senha do registry

## ğŸ“„ LicenÃ§a

MIT

## ğŸ‘¤ Autor

Rodrigo Quilez (@rlquilez)

## ğŸ¤ Contribuindo

ContribuiÃ§Ãµes sÃ£o bem-vindas! Sinta-se Ã  vontade para abrir issues e pull requests.

## ğŸ“š DocumentaÃ§Ã£o Adicional

- [DocumentaÃ§Ã£o FastAPI](https://fastapi.tiangolo.com/)
- [Exchange Calendars](https://github.com/gerrymanoim/exchange_calendars)
- [Redis Python Client](https://redis-py.readthedocs.io/)
- [Kong Gateway](https://docs.konghq.com/)
